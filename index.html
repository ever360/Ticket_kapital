<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ticket Kapital</title>
  <style>
    body {
      font-family: monospace;
      font-size: 13px;
      width: 300px;
      margin: auto;
      padding: 10px;
    }
    h2, h3, h4 {
      text-align: center;
      margin: 5px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    td {
      padding: 2px 0;
    }
    .bold {
      font-weight: bold;
    }
    hr {
      border: none;
      border-top: 1px dashed #000;
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <div id="ticket">
    <h2>KAPITAL</h2>
    <h4 id="ciudad"></h4>
    <div id="datos_empresa"></div>
    <hr>
    <div id="datos_cliente"></div>
    <hr>
    <div><b>Forma de pago:</b> <span id="FormaPago"></span></div>
    <hr>
    <table>
      <thead>
        <tr>
          <th>Cant</th>
          <th>Descripción</th>
          <th>Vr/U</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="detalle_venta"></tbody>
    </table>
    <hr>
    <div>Total Artículos: <span id="TotalArticulos"></span></div>
    <div><b>Total:</b> $<span id="Total"></span></div>
    <hr>
    <div style="text-align: center;">¡Gracias por su compra!</div>
    <div style="text-align: center;">www.kapital.com</div>
  </div>

  <script>
    function getParams() {
      const params = new URLSearchParams(window.location.search);
      const obj = {};
      for (const [key, value] of params.entries()) {
        obj[key] = decodeURIComponent(value.replace(/\+/g, ' '));
      }
      return obj;
    }

    function renderTicket(data) {
      document.getElementById("ciudad").textContent = data.ciudad || "";
      document.getElementById("datos_empresa").innerHTML = `
        <div>${data.representante || ""}</div>
        <div>NIT: ${data.Nit || ""}</div>
        <div>Tel: ${data.telefono || ""}</div>
        <div>${data.direccion || ""}</div>
        <div>${data.FechaHora || ""}</div>
        <div>Ticket: ${data.NoTicket || ""}</div>
      `;
      document.getElementById("datos_cliente").innerHTML = `
        <div><b>Cliente:</b> ${data.cliente || ""}</div>
        <div><b>ID:</b> ${data.Identificacion || ""}</div>
      `;
      document.getElementById("FormaPago").textContent = data.FormaPago || "";
      document.getElementById("TotalArticulos").textContent = data.TotalArticulos || "";
      document.getElementById("detalle_venta").innerHTML = data.DetalleVenta || "";
      
      // Calcular total directamente desde los <td> del total por fila
      let total = 0;
      const parser = new DOMParser();
      const doc = parser.parseFromString("<table>" + data.DetalleVenta + "</table>", "text/html");
      doc.querySelectorAll("td:nth-child(4)").forEach(td => {
        total += parseFloat(td.textContent || "0");
      });
      document.getElementById("Total").textContent = total.toLocaleString();
    }

    const datos = getParams();
    renderTicket(datos);

    window.onload = () => {
      window.print();
    };
  </script>
</body>
</html>
