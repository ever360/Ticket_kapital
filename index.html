<!-- El mismo HTML de antes, solo muestro la parte corregida del script -->

<script>
  // Obtener los parámetros de la URL
  const params = new URLSearchParams(window.location.search);

  const representante = params.get('representante') || "No especificado";
  const ciudad = params.get('ciudad') || "No especificada";
  const Nit = params.get('Nit') || "No especificado";  
  const telefono = params.get('telefono') || "No especificado";  
  const direccion = params.get('direccion') || "No especificada"; 
  const NoTicket = params.get('NoTicket') || "No especificado"; 
  const FechaHora = params.get('FechaHora') || "No especificada";
  const Identificacion = params.get('Identificacion') || "No especificada";
  const cliente = params.get('cliente') || "No especificado"; 
  const FormaPago = params.get('FormaPago') || "No especificado";
  const TotalArticulos = params.get('TotalArticulos') || "0";
  const DetalleVenta = params.get('DetalleVenta') || "No hay ventas";
  const SubTotal = params.get('SubTotal') || "$0.00";
  const Flete = params.get('Flete') || " $0.00";
  const Descuento = params.get('Descuento') || "$0.00";
  const Total = params.get('Total') || "$0.00";
  const Efectivo = params.get('Efectivo') || "$0.00";
  const Cambio = params.get('Cambio') || "$0.00";

  // Mostrar en el HTML
  document.getElementById("representante").textContent = representante;
  document.getElementById("Nit").textContent = Nit;
  document.getElementById("telefono").textContent = telefono;
  document.getElementById("direccion").textContent = direccion;
  document.getElementById("ciudad").textContent = ciudad;
  document.getElementById("NoTicket").textContent = NoTicket;
  document.getElementById("FechaHora").textContent = FechaHora;
  document.getElementById("Identificacion").textContent = Identificacion;
  document.getElementById("cliente").textContent = cliente;
  document.getElementById("FormaPago").textContent = FormaPago;
  document.getElementById("TotalArticulos").textContent = TotalArticulos;
  document.getElementById("DetalleVenta").innerHTML = DetalleVenta;
  document.getElementById("SubTotal").textContent = SubTotal;
  document.getElementById("Flete").textContent = Flete;
  document.getElementById("Descuento").textContent = Descuento;
  document.getElementById("Total").textContent = Total;
  document.getElementById("Efectivo").textContent = Efectivo;
  document.getElementById("Cambio").textContent = Cambio;

  if (FormaPago.toLowerCase() === "transferencia") {
    document.getElementById("Efectivo").style.display = "none";
    document.getElementById("Cambio").style.display = "none";
  }

  // Compartir PDF
  document.getElementById('btnCompartir').addEventListener('click', function () {
    const btnCompartir = document.getElementById('btnCompartir');
    const ticketElement = document.querySelector('.ticket');

    btnCompartir.classList.add('generating');
    btnCompartir.title = 'Generando PDF...';

    html2canvas(ticketElement, {
      scale: 3,
      useCORS: true,
      backgroundColor: '#ffffff',
      width: ticketElement.scrollWidth,
      height: ticketElement.scrollHeight
    }).then(function (canvas) {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: [80, 150]
      });

      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 75;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      if (imgHeight > 145) {
        pdf.internal.pageSize.height = imgHeight + 5;
      }

      pdf.addImage(imgData, 'PNG', 2.5, 2.5, imgWidth, imgHeight);

      const nombreCliente = cliente.replace(/[^a-zA-Z0-9]/g, '_');
      const nombreCiudad = ciudad.replace(/[^a-zA-Z0-9]/g, '_');
      const nombreArchivo = `${nombreCliente}_PVC_${nombreCiudad}.pdf`;

      const pdfBlob = pdf.output('blob');
      const file = new File([pdfBlob], nombreArchivo, { type: "application/pdf" });

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        navigator.share({
          files: [file],
          title: `Ticket ${cliente} - PVC ${ciudad}`,
          text: `Comprobante de compra - Cliente: ${cliente}, Ciudad: ${ciudad}`
        })
        .then(() => {
          btnCompartir.classList.remove('generating');
          btnCompartir.classList.add('success');
          btnCompartir.title = '¡Compartido!';
          setTimeout(() => {
            btnCompartir.classList.remove('success');
            btnCompartir.title = 'Compartir PDF';
          }, 2000);
        })
        .catch((error) => {
          console.error('Error al compartir PDF:', error);
          manejarErrorCompartir(pdf, nombreArchivo, btnCompartir);
        });
      } else {
        manejarErrorCompartir(pdf, nombreArchivo, btnCompartir);
      }
    }).catch(function (error) {
      console.error('Error al generar PDF:', error);
      btnCompartir.classList.remove('generating');
      btnCompartir.classList.add('error');
      btnCompartir.title = 'Error al generar PDF';
      setTimeout(() => {
        btnCompartir.classList.remove('error');
        btnCompartir.title = 'Compartir PDF';
      }, 3000);
    });
  });

  function manejarErrorCompartir(pdf, nombreArchivo, btnCompartir) {
    pdf.save(nombreArchivo);
    btnCompartir.classList.remove('generating');
    btnCompartir.classList.add('success');
    btnCompartir.title = 'PDF descargado';

    setTimeout(() => {
      const mensaje = `🧾 *COMPROBANTE PVC - ${ciudad.toUpperCase()}*

📋 Ticket: ${NoTicket}
👤 Cliente: ${cliente}
📅 Fecha: ${FechaHora}
💰 Total: ${Total}
💳 Pago: ${FormaPago}
🏙️ Ciudad: ${ciudad}

✅ Ticket generado para ${cliente}
📄 PDF: ${nombreArchivo}

Gracias por tu compra en Cielo Razos PVC`;

      if (confirm('PDF descargado. ¿Deseas compartir los detalles por WhatsApp?')) {
        const urlWhatsApp = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
        window.open(urlWhatsApp, '_blank');
      }

      btnCompartir.classList.remove('success');
      btnCompartir.title = 'Compartir PDF';
    }, 1500);
  }

  // Auto impresión al cargar
  window.onload = () => {
    window.print();
  };
</script>
